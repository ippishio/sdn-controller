# Балансировщик нагрузки на SDN-контроллере

## Предисловие
в связи с неприятным стечением жизненных обстоятельств, на работу над заданием мне выдалось очень небольшое кол-во времени, поэтому выкладываю/показываю код as-is


## Запуск
### Установка зависимостей
```bash
user@ubuntu:~/sdn-controller$ pip3 install -r requirements.txt
```
### Запуск **mininet**
Необходимо настроенное `mininet` окружение. В моем случае это был подготовленный образ VM с репозитория `mininet` на домашнем сервере.
```bash
mininet@mininet:~$ cd sdn-controller/topology
mininet@mininet:~/sdn-controller/topology$ sudo python3 example-topology.py
```
В скрпите необходимо указать актуальный IP контроллера

### Запуск контроллера
```bash
mininet@mininet:~/sdn-controller$ python3 run.py
```
## Архитектура

Контроллер основан на `os-ken`, при запуске происходят следующие действия:

1. Отправляется `OFPSwitchFeatures` на подключенные коммутаторы, устанавливается связь с ними.
2. В параллельном процессе запускается `FastAPI` сервер, открывается `pipe` для связи с процессом сервера
3. Контроллер запускает `_api_listener` демон, который слушает входящие запросы с `FastAPI` и выполняет соответствующие методы контроллера.

Такая странная связь контроллера и REST API сервера была выбрана вынужденно, ведь запущенные в одном процессе потоки двух этих модулей начинают конфликтовать друг с другом (`asyncio` в `FastAPI` и `greenlet` в `os-ken`)

В подмодуле `api` реализован класс `ControllerAdapter` позволяющий делать Remote Procedure Call. Этот класс позволяет работать с методами контроллера из другого процесса, конвертируя вызовы собственных методов в запрос, отправляемый через `pipe`

Также в `api` реализованно некое подобие ORM на основе моковой базы данных, где хранятся правила балансировки

## Что не получилось/не успелось
- REST API коммуницирует с контроллером в одностороннем режиме. База данных в подмодуле API существует только там и не имеет никакой обратной связи с контроллером
- Выбор алгоритма. Nicira Extensions не поддавалось, так как не получилось найти релевантную информацию. Метод `nicira_add_algorithm_to_group` есть, но почему-то не работает, следовательно не используется
- Следствие прошлого пункта - внутри группы пакеты отправляются только на один бакет.
- Подмена src_ip на VIP в ответном пакете. Не получилось разобраться с `conntrack` как с частью Nicira Extensions
- Endpoint `/delete` - не работает, т.к. не работают методы `delete_flow`, `delete_group` контроллера - не успел разобраться
- Endpoint `/put` - не успел реализовать

## Пример запроса

```http d
   POST http://localhost:8080/rules/
   Content-Type: application/json
   {
        "protocol": 1,
        "virtual_ip": "10.0.0.11",
        "backend_ip": [
            "10.0.0.3",
            "10.0.0.4"
        ],
        "algorithm": 0
   }

   # Reply
    {
        "uid": "4ccd6c7c-3ab5-4162-a038-93f13694d81d",
        "protocol": 1,
        "port": null,
        "virtual_ip": "10.0.0.11",
        "backend_ip": [
            "10.0.0.3",
            "10.0.0.4"
        ],
        "algorithm": 0
   }
   ```